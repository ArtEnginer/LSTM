{% extends "base.html" %}

{% block title %}Modelling{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>Train LSTM Model</h3>
            </div>
            <div class="card-body">
                <form>
                    <div class="mb-3 row">
                        <div class="col-md-6">
                            <label for="optimizer" class="form-label">Optimizer:</label>
                            <select class="form-select" name="optimizer" id="optimizer" required>
                                <option value="adam">Adam</option>
                                <option value="sgd">SGD</option>
                                <option value="rmsprop">RMSprop</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="loss" class="form-label">Loss Function:</label>
                            <select class="form-select" name="loss" id="loss" required>
                                <option value="mean_squared_error">Mean Squared Error</option>
                                <option value="mean_absolute_error">Mean Absolute Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-md-6">
                            <label for="epochs" class="form-label">Epochs:</label>
                            <input type="number" class="form-control" name="epochs" id="epochs" value="10" required>
                        </div>
                        <div class="col-md-6">
                            <label for="batch_size" class="form-label">Batch Size:</label>
                            <input type="number" class="form-control" name="batch_size" id="batch_size" value="32"
                                required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-md-4">
                            <label for="time_step" class="form-label">Time Step:</label>
                            <input type="number" class="form-control" name="time_step" id="time_step" value="15"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label for="train_size" class="form-label">Training Data Percentage:</label>
                            <input type="number" class="form-control" name="train_size" id="train_size" value="0.7"
                                step="0.1" min="0.1" max="0.9" required>
                        </div>
                    </div>
                    <!-- validation size -->
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success btn-submit full-width-btn">Train Model</button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div id="output-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="flash-message"></div>
        <div id="output-details">
            <!-- Detail output (seperti loss) akan ditampilkan di sini -->
        </div>
        <div id="training-graph">
            <!-- Training graph will be displayed here -->
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.btn-submit').on('click', function () {
            // Tampilkan animasi loading saat tombol ditekan
            $('#loading-overlay').addClass('loading');
        });

        $('form').on('submit', function (event) {
            event.preventDefault(); // Menghentikan pengiriman formulir standar

            var formData = new FormData($(this)[0]);

            $.ajax({
                type: 'POST',
                url: '/modelling_proses',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    // Hapus animasi loading setelah respons diterima
                    $('#loading-overlay').removeClass('loading');

                    var outputDetails = response.output_details;
                    var epochs = outputDetails.epochs;
                    var batch_size = outputDetails.batch_size;
                    var optimizer = outputDetails.optimizer;
                    var loss = outputDetails.loss;
                    var time_step = outputDetails.time_step;
                    var train_size = outputDetails.train_size;
                    var validation_size = outputDetails.validation_size;
                    var average_accuracy = outputDetails.average_accuracy;
                    var average_val_accuracy = outputDetails.average_val_accuracy;
                    var average_loss = outputDetails.average_loss;
                    var average_val_loss = outputDetails.average_val_loss;
                    var rmse = outputDetails.rmse;
                    var mse = outputDetails.mse;
                    var accuracy_plot = outputDetails.visualizations.accuracy_plot;

                    $('#output-details').html(`
    <table>
        <tr>
            <td>Epochs</td>
              <td>:</td>
            <td>${epochs}</td>
        </tr>
        <tr>
            <td>Batch Size</td>
              <td>:</td>
            <td>${batch_size}</td>
        </tr>
        <tr>
            <td>Optimizer</td>
              <td>:</td>
            <td>${optimizer}</td>
        </tr>
        <tr>
            <td>Loss Function</td>
              <td>:</td>
            <td>${loss}</td>
        </tr>
        <tr>
            <td>Time Step</td>
              <td>:</td>
            <td>${time_step}</td>
        </tr>
        <tr>
            <td>Train Size</td>
              <td>:</td>
            <td>${train_size}</td>
        </tr>
        <tr>
            <td>Validation Size</td>
              <td>:</td>
            <td>${validation_size}</td>
        </tr>
        <tr>
            <td>Average Accuracy</td>
              <td>:</td>
            <td>${average_accuracy}</td>
        </tr>
        <tr>
            <td>Average Validation Accuracy</td>
              <td>:</td>
            <td>${average_val_accuracy}</td>
        </tr>
        <tr>
            <td>Average Loss</td>
              <td>:</td>
            <td>${average_loss}</td>
        </tr>
        <tr>
            <td>Average Validation Loss</td>
              <td>:</td>
            <td>${average_val_loss}</td>
        </tr>
        <tr>
            <td>RMSE</td>
              <td>:</td>
            <td>${rmse}</td>
        </tr>
        <tr>
            <td>MSE</td>
              <td>:</td>
            <td>${mse}</td>
        </tr>
    </table>
`);


                    // Display training graph
                    $('#training-graph').html(`<img src="{{ url_for('model', filename='accuracy_plot.png') }}" class="img-fluid"
                        alt="Accuracy Plot">`);

                    // Tampilkan modal
                    $('#output-modal').css('display', 'block');
                },
                error: function (error) {
                    // tampilkan message response error
                    console.log(error.responseJSON.message);

                    // Hapus animasi loading jika terjadi kesalahan
                    $('#loading-overlay').removeClass('loading');
                    // Tampilkan pesan error jika ada
                    $('#flash-message').html('<div class="error">Error training model</div>');
                }
            });
        });

        // Fungsi untuk menutup modal saat tombol close ditekan
        $('.close').on('click', function () {
            $('#output-modal').css('display', 'none');
        });

        // Fungsi untuk menutup modal saat klik di luar modal
        $(window).on('click', function (event) {
            if (event.target.id === 'output-modal') {
                $('#output-modal').css('display', 'none');
            }
        });
    });
</script>

<style>
    /* Gaya untuk animasi loading */
    #loading-overlay {
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #loading-overlay.loading {
        display: flex;
    }

    #loading-spinner {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    .caption-spinner {
        text-align: center;
        margin-top: 20px;
        color: #ffffff;
        font-family: Arial, sans-serif;
    }

    .caption-spinner>span {
        display: block;
        font-size: 14px;
        margin-top: 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Gaya untuk modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .full-width-btn {
        display: block;
        width: 100%;
        margin: 0;
        /* Remove default margin for better control */
        box-sizing: border-box;
        /* Ensure padding and border are included in width */
    }
</style>

<!-- Tambahkan elemen overlay untuk animasi loading -->
<div id="loading-overlay">
    <div id="loading-spinner">
    </div>
    <div class="caption-spinner">
        <p>Mohon tunggu, proses modelling sedang berlangsung...</p>
        <span>
            Anda tidak dapat refresh halaman ini karena akan mengulang proses modelling.
        </span>
    </div>
</div>

{% endblock %}