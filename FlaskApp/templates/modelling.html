{% extends "base.html" %}

{% block title %}Modelling{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h1>Train LSTM Model</h1>
            </div>
            <div class="card-body">
                <form enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Upload Dataset:</label>
                        <input type="file" class="form-control" name="file" id="file" required>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-md-6">
                            <label for="optimizer" class="form-label">Optimizer:</label>
                            <select class="form-select" name="optimizer" id="optimizer" required>
                                <option value="adam">Adam</option>
                                <option value="sgd">SGD</option>
                                <option value="rmsprop">RMSprop</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="loss" class="form-label">Loss Function:</label>
                            <select class="form-select" name="loss" id="loss" required>
                                <option value="mean_squared_error">Mean Squared Error</option>
                                <option value="mean_absolute_error">Mean Absolute Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-md-6">
                            <label for="epochs" class="form-label">Epochs:</label>
                            <input type="number" class="form-control" name="epochs" id="epochs" value="10" required>
                        </div>
                        <div class="col-md-6">
                            <label for="batch_size" class="form-label">Batch Size:</label>
                            <input type="number" class="form-control" name="batch_size" id="batch_size" value="1"
                                required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-md-4">
                            <label for="time_step" class="form-label">Time Step:</label>
                            <input type="number" class="form-control" name="time_step" id="time_step" value="1"
                                required>
                        </div>
                        <div class="col-md-4">

                            <label for="train_size" class="form-label">Training Data Percentage:</label>
                            <input type="number" class="form-control" name="train_size" id="train_size" value="0.7"
                                step="0.1" min="0.1" max="0.9" required>
                        </div>
                        <div class="col-md-4">

                            <label for="validation_size" class="form-label ">Validation Data Percentage:</label>
                            <input type="number" class="form-control" name="validation_size" id="validation_size"
                                value="0.2" step="0.1" min="0.1" max="0.9" required>
                        </div>
                    </div>
                    <!-- validation size -->


                    <button type="submit" class="btn btn-primary btn-submit">Train Model</button>
                </form>
            </div>
        </div>
    </div>
</div>


<div id="flash-message"></div>

<!-- Modal untuk menampilkan hasil proses modelling -->
<div id="output-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="output-details">
            <!-- Detail output (seperti loss) akan ditampilkan di sini -->
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.btn-submit').on('click', function () {
            // Tampilkan animasi loading saat tombol ditekan
            $('#loading-overlay').addClass('loading');
        });

        $('form').on('submit', function (event) {
            event.preventDefault(); // Menghentikan pengiriman formulir standar

            var formData = new FormData($(this)[0]);

            $.ajax({
                type: 'POST',
                url: '/modelling_proses',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    // Hapus animasi loading setelah respons diterima
                    $('#loading-overlay').removeClass('loading');

                    // Tampilkan pesan sukses di flash message
                    $('#flash-message').html('<div class="success">Model trained successfully</div>');

                    var outputDetails = response.output_details;
                    var lossValue = outputDetails.loss_value;

                    $('#output-details').html(`
                        <p><strong>Loss Value:</strong> ${lossValue}</p>
                        <!-- Tambahkan tampilan untuk metrik lain jika diperlukan -->
                        <!-- <p><strong>Other Metric:</strong></p> -->
                    `);

                    // Tampilkan modal
                    $('#output-modal').css('display', 'block');
                },
                error: function (error) {
                    // Hapus animasi loading jika terjadi kesalahan
                    $('#loading-overlay').removeClass('loading');

                    // Tampilkan pesan error jika ada
                    $('#flash-message').html('<div class="error">Error training model</div>');
                }
            });
        });

        // Fungsi untuk menutup modal saat tombol close ditekan
        $('.close').on('click', function () {
            $('#output-modal').css('display', 'none');
        });

        // Fungsi untuk menutup modal saat klik di luar modal
        $(window).on('click', function (event) {
            if (event.target.id === 'output-modal') {
                $('#output-modal').css('display', 'none');
            }
        });
    });
</script>

<style>
    /* Gaya untuk animasi loading */
    #loading-overlay {
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #loading-overlay.loading {
        display: flex;
    }

    #loading-spinner {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    .caption-spinner {
        text-align: center;
        margin-top: 20px;
        color: #ffffff;
        font-family: Arial, sans-serif;
    }

    .caption-spinner>span {
        display: block;
        font-size: 14px;
        margin-top: 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Gaya untuk modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<!-- Tambahkan elemen overlay untuk animasi loading -->
<div id="loading-overlay">
    <div id="loading-spinner">
    </div>
    <div class="caption-spinner">
        <p>Mohon tunggu, proses modelling sedang berlangsung...</p>
        <span>
            Anda tidak dapat refresh halaman ini karena akan mengulang proses modelling.
        </span>
    </div>
</div>

{% endblock %}